<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rezultati.domena</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
        const wsUri = "ws://localhost:8081";
        let results;
        let ws;
        $(document).ready(function () {
            if (!init()) {
                return;
            }
            createSocket();
        });

        function init() {
            if (!window.WebSocket) {
                alert("This browser doesn't support WebSocket!!");
                return false;
            }
            results = $("#results");
            return true;
        }

        function createSocket() {
            ws = new WebSocket(wsUri);
            ws.onopen = evt => onOpen(evt);
            ws.onclose = evt => onClose(evt);
            ws.onerror = evt => onError(evt);
            ws.onmessage = evt => onMessage(evt);
        }

        function onOpen(evt) {
            $("#con-status").text("Connected");
        }

        function onClose(evt) {
            $("#con-status").text("Disconnected");
            createSocket();
        }

        function onError(evt) {
            $("#con-status").text("Something went wrong!!");
        }

        function onMessage(evt) {
            let msg = JSON.parse(evt.data);
            switch (msg.type.toLowerCase()) {
                case "all":
                    // alert("Primljeni svi rezultati!!");
                    $("#res-table tbody").empty();
                    msg.games.forEach(g => add_table_row(g));
                    break;
                case "update":
                    // alert("Primljen update");
                    update_table_row(msg.game);
                    break;
                default:
                    alert("Primljena neispravna poruka");
                // todo: ignore?

            }
        }

        function add_table_row(game) {
            let html = "<tr id=tr_" + game.id + ">";
            html += form_game_table_row(game);
            html += "</tr>";

            $("#res-table tbody").append(html);
        }

        function update_table_row(game) {
            $("#tr_" + game.id).html(form_game_table_row(game));
        }

        function convert_number_to_string(down) {
            switch (down) {
                case 1:
                    return "1st";
                case 2:
                    return "2nd";
                case 3:
                    return "3rd";
                case 4:
                    return "4th";
                default:
                    return null;
            }
        }

        function form_game_table_row(game) {

            let html = "<td id='" + game.id + "-away'>" + game.away.name +
                (game.possession === game.away.short ? "&middot" : "") + "</td>"; // dodaj away
            html += "<td id='" + game.id + "-score'>" + game.score.away + " : " + game.score.home + "</td>"; // dodaj score
            html += "<td id='" + game.id + "-home'>" + game.home.name +
                (game.possession === game.home.short ? "&middot" : "") + "</td>"; // dodaj home
            html += "<td id='" + game.id + "-time'>" + convert_number_to_string(game.time.quarter) + " "
                + game.time.clock.min + ":" + ("%0" + game.time.clock.sec).slice(-2) + "</td>"; // dodaj time
            html += "<td id='" + game.id + "-ballSpot'>" + game.ballSpot.side + " " + check_yards(game.ballSpot.yd) + "</td>"; // dodaj lokaciju lopte
            html += "<td id='" + game.id + "-driveStatus'>" + convert_number_to_string(game.driveStatus.down) +
                " & " + check_yards(game.driveStatus.yd) + "</td>"; // dodaj down
            html += "<td id='" + game.id + "-stadium'>" + game.stadium + "</td>"; // dodaj stadium
            return html;
        }

        function check_yards(yd) {
            return yd < 1 ? "inches" : yd;
        }
    </script>
</head>
<body>
<h2>Dobrodošli na rezultate uživo</h2>
Ispod se nalaze trenutni rezultati koje pratimo, ostanite na stranici kako biste pratili rezultate.
<div id="con-status">Connecting...</div>
<div id="results">
    <table id="res-table">
        <thead>
        <tr>
            <th>Away</th>
            <th>Score</th>
            <th>Home</th>
            <th>Time</th>
            <th>Ball on</th>
            <th>Down</th>
            <th>Stadium</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
</body>
</html>